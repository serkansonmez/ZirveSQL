 create view  VW_CekListesi_2022 as 
SELECT CONVERT(NUMERIC(10,0),VADE) AS AGRUP,ISNULL(BORDROCEKLER.TUTAR,0)-ISNULL(KISMILER.KISMITAHSILTL,0) AS TUTAR,ISNULL(BORDROCEKLER.DVZMIKTAR,0)-ISNULL(KISMILER.KISMITAHSILD,0) AS DVZMIKTAR,month(VADE) as CAYI,ASILCARIUNVANI=CASE WHEN ISNULL(CARIADI,'') <> '' THEN CARIADI ELSE (SELECT ISNULL(STA,'') FROM  [TUÐRAL_DÖKÜM_LTD_2022T]..CARIGEN WHERE P_ID = ISNULL(BORDROCEKLER.ASILCARIP_ID,'')) END,BORDROCEKLER.* FROM  [TUÐRAL_DÖKÜM_LTD_2022T]..BORDROCEKLER LEFT JOIN (SELECT CEK_PID,SUM(ISNULL(KODEMETL,0)) AS KISMITAHSILTL,SUM(ISNULL(KODEMED,0)) AS KISMITAHSILD FROM [TUÐRAL_DÖKÜM_LTD_2022T]..BORDROCEKLER WHERE BRDTUR = 106 AND DURUM IN (11,16) AND DDTARIHI <= '20221231'group by CEK_PID) AS KISMILER ON KISMILER.CEK_PID = BORDROCEKLER.CEK_PID 
WHERE (((((Vade>='20220101')and(Vade<='20221231')) and (Durum IN (2,12))) and (Tur IN (1))) and (REF IN (SELECT MAX(REF) FROM [TUÐRAL_DÖKÜM_LTD_2022T]..BORDROCEKLER AS ALT WHERE ALT.CEK_PID = BORDROCEKLER.CEK_PID AND DDTARIHI=(SELECT MAX(DDTARIHI) FROM [TUÐRAL_DÖKÜM_LTD_2022T]..BORDROCEKLER AS AALT WHERE AALT.CEK_PID=BORDROCEKLER.CEK_PID AND AALT.DDTARIHI <='20221231') ))) and ((ISNULL(BRDBANKAREFNO,0) IN (SELECT BANKAREFNO FROM  [TUÐRAL_DÖKÜM_LTD_2022T]..BANKGEN WHERE (BANKAKODU>='102.10.001')and(BANKAKODU<='102.10.016'))) or (ISNULL(BANKAREFNO,0) IN (SELECT BANKAREFNO FROM  [TUÐRAL_DÖKÜM_LTD_2022T]..BANKGEN WHERE (BANKAKODU>='102.10.001')and(BANKAKODU<='102.10.016'))))
order by VADE
